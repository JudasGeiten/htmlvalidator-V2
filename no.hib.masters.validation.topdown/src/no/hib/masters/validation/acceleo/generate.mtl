[comment encoding = UTF-8 /]
[module generate('http://www.eclipse.org/emf/2002/Ecore')]

[template public generateElement(anEPackage : EPackage)]
[comment @main/]
[file (anEPackage.name.concat('Rules.xq'), false, 'UTF-8')]

(: ****** PROTECTED SECTION ****** :)

declare namespace difiFunctions = "www.example.org";
declare function difiFunctions:is-value-in-sequence
  ( $value as xs:anyAtomicType? ,
    $seq as xs:anyAtomicType* )  as xs:boolean {

   $value = $seq
 };

(: ****** END OF PROTECTED SECTION ****** :)

		[for (class : EClass | anEPackage.eClassifiers)]
			[for (reference : EReference | class.eAllReferences)]				
				[if(reference.lowerBound > 0)]
				(: [class.name/] -> [reference.eType.name/] :)

					for $[class.name/] in doc("test.html")//[class.name/]
					let $[class.name/][reference.eType.name/] := $[class.name/]/@[reference.name/]
					where not(difiFunctions:is-value-in-sequence($[class.name/][reference.eType.name/], doc("test.html")//[reference.eType.name/]/@id))
					return $[class.name/]
				[if(not reference.eOpposite.oclIsUndefined())]
				(:  [class.name/] <-> [reference.eType.name/] :)
					(: bidirectional :)
					for $[reference.eOpposite.eType.name/] in doc("test.html")//[reference.eOpposite.eType.name/]
					let $[class.name/][reference.eType.name/] := $[class.name/]/@id
					where not(difiFunctions:is-value-in-sequence($[class.name/][reference.eType.name/], doc("test.html")//[class.name/]/@[reference.name/]))
					return $[class.name/]
				[/if]
				[/if]
			[/for]
			[for (attr : EAttribute | class.eAllAttributes)]
				[if(attr.lowerBound > 0)]
				(: [class.name/] must contain [attr.name/] :)

					for $[class.name/] in doc("test.html")//[class.name/]
					where empty($[class.name/]/@[attr.name/])
					return $[class.name/]

				[/if]
			[/for]

		[/for]
[/file]
[/template]
